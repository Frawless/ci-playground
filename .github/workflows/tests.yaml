name: Unit & Integration tests

on:
  pull_request:
    paths:
      - '.github/**'
  push:
    branches:
      - "main"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker://rhysd/actionlint:latest
        with:
          args: -color

  integration:
    needs:
      - lint
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        case:
          # ─── Scenario 1 ──────────────────────────────
          - id: comment-pipeline-only
            fixture: .github/tests/events/issue_comment_1.json
            expect_pipelines: 'regression,upgrade'
            expect_profiles: ''
            expect_tests: ''
            expect_groups: ''
            expect_kafka: 'latest'
            workflow: .github/tests/workflows/parse-comment-template.yaml
          # ─── Scenario 2 ──────────────────────────────
          - id: comment-profile-only
            fixture: .github/tests/events/issue_comment_2.json
            expect_pipelines: ''
            expect_profiles: 'operators,operands'
            expect_tests: 'strimzi-tests'
            expect_groups: ''
            expect_kafka: 'latest'
            workflow: .github/tests/workflows/parse-comment-template.yaml
          # ─── Scenario 3 ──────────────────────────────
          - id: comment-additional-params
            fixture: .github/tests/events/issue_comment_3.json
            expect_pipelines: 'regression,upgrade'
            expect_profiles: ''
            expect_tests: ''
            expect_groups: 'nodeport'
            expect_kafka: '4.1.0'
            expect_kube: '1.33.1'
            expect_architecture: 'arm64'
            expect_agent: 'strimzi-agent'
            workflow: .github/tests/workflows/parse-comment-template.yaml
          # ─── Scenario 4 ──────────────────────────────
          - id: comment-pipeline-and-profile
            fixture: .github/tests/events/issue_comment_4.json
            expect_pipelines: 'regression,upgrade'
            expect_profiles: ''
            expect_groups: ''
            expect_kafka: 'latest'
            workflow: .github/tests/workflows/parse-comment-template.yaml
          # ─── Scenario 5 ──────────────────────────────
          - id: comment-pipeline-and-profile
            fixture: .github/tests/events/issue_comment_5.json
            expect_pipelines: ''
            expect_profiles: 'operators'
            expect_groups: ''
            expect_kafka: 'latest'
            workflow: .github/tests/workflows/parse-comment-template.yaml
          # ─── Scenario 6 ──────────────────────────────
          - id: dispatch
            fixture: .github/tests/events/dispatch_default.json
            expect_pipelines: ''
            expect_profiles: 'operators,operands,brokers-and-security,azp_kraft_upgrade,azp_kafka_upgrade'
            expected_kafka: 'latest'
            workflow: .github/tests/workflows/parse-comment-template.yaml
    steps:
      - uses: actions/checkout@v4

      # Install `act` (one-liner script; runner already has Docker)
      - name: Install act
        run: |
          curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
          sudo install -m 0755 ./bin/act /usr/local/bin/act

      # Run the template workflow with the current fixture
      - name: Smoke test – ${{ matrix.case.id }}
        # `act` itself is a plain shell command, so this step only needs `run:`
        run: |
          act -W "${{ matrix.case.workflow }}" \
              -e "${{ matrix.case.fixture }}" \
              -P ubuntu-latest=catthehacker/ubuntu:act-latest \
              --pull=false \
              --env EXPECT_PIPELINES="${{ matrix.case.expect_pipelines }}" \
              --env EXPECT_PROFILES="${{ matrix.case.expect_profiles }}" \
              --env EXPECT_TESTS="${{ matrix.case.expect_tests }}" \
              --env EXPECT_GROUPS="${{ matrix.case.expect_groups }}" \
              --env EXPECT_KAFKA="${{ matrix.case.expect_kafka }}" \
              --env EXPECT_KUBE="${{ matrix.case.expect_kube }}" \
              --env EXPECT_ARCHITECTURE="${{ matrix.case.expect_architecture }}" \
              --env EXPECT_AGENT="${{ matrix.case.expect_agent }}"
